context("Dictionary")

test_that("Dictionary", {
  Foo = R6::R6Class("Foo", public = list(x=0, id=NULL, initialize = function(x) self$x = x), cloneable = TRUE)
  d = Dictionary$new()
  expect_identical(d$ids(), character(0L))

  f1 = Foo$new(1)
  f1$id = "f1"
  f2 = Foo$new(2)
  f2$id = "f2"

  expect_false(d$has("f1"))
  d$add("f1", f1)
  expect_identical(d$ids(), "f1")
  expect_true(d$has("f1"))
  f1c = d$get("f1")
  expect_different_address(f1, f1c)
  expect_list(d$mget("f1"), names = "unique", len = 1, types = "Foo")

  d$add("f2", f2)
  expect_set_equal(d$ids(), c("f1", "f2"))
  expect_list(d$mget(c("f1", "f2")), names = "unique", len = 2, types = "Foo")

  d$add("f2", f2)
  expect_set_equal(d$ids(), c("f1", "f2"))
  expect_list(d$mget(c("f1", "f2")), names = "unique", len = 2, types = "Foo")

  d$remove("f2")
  expect_set_equal(d$ids(), "f1")
  expect_false(d$has("f2"))

  expect_data_frame(as.data.frame(d), nrow = 1L)
  expect_data_table(as.data.table(d), nrow = 1L)
})

test_that("Dictionary: lazy values", {
  expect_function(mlr_tasks$items$iris)

  t1 = mlr_tasks$get("iris")
  expect_task(t1)
  t2 = mlr_tasks$get("iris")
  expect_task(t2)
  expect_different_address(t1, t2)
})

test_that("$ids(pattern) works", {
  expect_subset(mlr_learners$ids("classif"), mlr_learners$ids(), empty.ok = FALSE)
})

test_that("Dictionaries are populated", {
  expect_dictionary(mlr_tasks, "Task", min.items = 1L)
  expect_dictionary(mlr_learners, "Learner", min.items = 1L)
  expect_dictionary(mlr_resamplings, "Resampling", min.items = 1L)
  expect_dictionary(mlr_measures, "Measure", min.items = 1L)

  expect_data_table(as.data.table(mlr_tasks), nrow = length(mlr_tasks$ids()))
  expect_data_table(as.data.table(mlr_learners), nrow = length(mlr_learners$ids()))
  expect_data_table(as.data.table(mlr_resamplings), nrow = length(mlr_resamplings$ids()))
  expect_data_table(as.data.table(mlr_measures), nrow = length(mlr_measures$ids()))
})

test_that("Error when a package containing the dataset is not installed", {
  test_task = DictionaryTask$new()
  test_task$add("missing_package", function() {
    b = DataBackendDataTableVirtualKey$new(data = load_dataset("xxx", "missing_package_123"))
    TaskClassif$new("missing_package", b, target = "x", positive = "y")
  })
  expect_error(test_task$get("missing_package"))
})
